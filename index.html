import React, { useEffect, useMemo, useState } from "react";
import {
  LineChart, Line, BarChart, Bar, AreaChart, Area,
  XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend, ScatterChart, Scatter, ZAxis
} from "recharts";

/**
 * Photon Options Dashboard — PRO Mock (Leader → Followers)
 * نسخة متقدمة تجمع كل المتطلبات: Flow/Dealer · IV/Surface · Chains/Greeks · Trade · Risk · Journal · Observability
 * تعقيد داخلي + واجهة بسيطة (نمط Apple)
 *
 * ⚠️ ملاحظة: هذا DEMO بدون ربط حقيقي — جاهز للتوصيل بمزوّدين (Polygon/Barchart/Hanweck/SpotGamma…)
 * يوفّر نقاط ربط، حرس المخاطرة، Price/Drift Guards، وقياسات تشغيلية.
 */

// ===== Helpers =====
const fmt = new Intl.NumberFormat("en-US", { maximumFractionDigits: 2 });
const pct = (x:number) => `${(x*100).toFixed(2)}%`;
const now = () => new Date().toLocaleTimeString();

// ===== Default Risk (من خطتك) =====
const DEFAULT_RISK = {
  unit: 266,
  fib_steps: [1,1,2,3,5,8,13,21,34,55],
  target_R: 5,
  daily_cap_step_max: { x1_0: 8, x1_25: 8, x1_5: 7 },
  loss_limits: { daily_pct: 0.054, weekly_pct: 0.108 },
  profit_withdraw_pct: 0.15,
  price_tolerance_pct: 0.006,   // 0.6%
  slippage_max_pct: 0.008,      // 0.8%
  cool_down_on_2_losses_min: 60
};

// ===== Demo Accounts =====
const DEFAULT_ACCOUNTS = [
  { id: "A", name: "محفظة A", equity: 100000, pnlDay: 3200 },
  { id: "B", name: "محفظة B", equity: 80000,  pnlDay: -1500 },
  { id: "C", name: "محفظة C", equity: 60000,  pnlDay: 2200 },
  { id: "D", name: "محفظة D", equity: 120000, pnlDay: 4800 },
  { id: "E", name: "محفظة E", equity: 50000,  pnlDay: -800 }
];

// ===== Demo Data Providers (مفاتيح) =====
const DEFAULT_PROVIDERS = {
  polygon: { enabled: true, apiKey: "pk_demo_xxx" },
  barchart: { enabled: true, apiKey: "bc_demo_xxx" },
  hanweck: { enabled: false, apiKey: "" },
  spotgamma: { enabled: true, apiKey: "sg_demo_xxx" },
  tier1alpha: { enabled: false, apiKey: "" },
};

// ===== Demo Flow/GEX/IV/Chains =====
const demoFlows = [
  { ts: "09:45:11", type: "SWEEP",  symbol: "NVDA", side: "CALL",  size: 1500, prem: 1_250_000, delta: 0.38, note: "Agg Ask" },
  { ts: "10:02:07", type: "BLOCK",  symbol: "AAPL", side: "PUT",   size: 2200, prem: 980_000,  delta: -0.32, note: "Hedge?" },
  { ts: "10:14:33", type: "SWEEP",  symbol: "TSLA", side: "CALL",  size: 900,  prem: 720_000,  delta: 0.42, note: "Multi-exch" },
  { ts: "10:31:18", type: "BLOCK",  symbol: "AMZN", side: "CALL",  size: 1200, prem: 1_100_000,delta: 0.36, note: "LT DTE" },
];

const demoGEX = [
  { strike: 450, gex: -1.2 }, { strike: 455, gex: -0.8 }, { strike: 460, gex: -0.2 }, { strike: 465, gex: 0.4 },
  { strike: 470, gex: 1.0 },  { strike: 475, gex: 1.8 },  { strike: 480, gex: 2.6 },  { strike: 485, gex: 1.1 }
];

const demoTerm = [
  { dte: "0DTE", iv: 0.34 }, { dte: "1D", iv: 0.31 }, { dte: "2D", iv: 0.29 }, { dte: "1W", iv: 0.27 }, { dte: "2W", iv: 0.26 }, { dte: "1M", iv: 0.25 }
];

const demoSurface = [
  // strike × maturity (تبسيط: جدول)
  { strike: 450, m0: 0.34, m1: 0.31, m2: 0.29, w1: 0.27, w2: 0.26, mth1: 0.25 },
  { strike: 460, m0: 0.35, m1: 0.32, m2: 0.30, w1: 0.28, w2: 0.27, mth1: 0.26 },
  { strike: 470, m0: 0.33, m1: 0.30, m2: 0.28, w1: 0.26, w2: 0.25, mth1: 0.24 },
  { strike: 480, m0: 0.31, m1: 0.29, m2: 0.27, w1: 0.25, w2: 0.24, mth1: 0.23 },
];

const demoChain = Array.from({length: 14}).map((_,i)=>{
  const strike = 450 + i*5; const iv = 0.28 + Math.sin(i/2)/50; const delta = Math.max(0, Math.min(1, 0.6 - i*0.04));
  return {
    strike,
    bid: +(2 + Math.max(0,5-i)*0.4).toFixed(2),
    ask: +(2.15 + Math.max(0,5-i)*0.4).toFixed(2),
    vol: Math.floor(500 + Math.random()*3000),
    oi: Math.floor(1000 + Math.random()*8000),
    iv: +(iv).toFixed(3),
    delta: +(delta).toFixed(2), gamma: +(delta*(1-delta)/50).toFixed(3), theta: -+(0.02 + i*0.001).toFixed(3), vega: +(0.08 - i*0.002).toFixed(3)
  };
});

// ===== Core UI Helpers =====
const Badge: React.FC<{text: string; tone?: "green"|"red"|"blue"|"gray"|"yellow"}> = ({text, tone="gray"}) => {
  const map:any = { green: "bg-green-50 text-green-700 border-green-200", red: "bg-red-50 text-red-700 border-red-200", blue: "bg-blue-50 text-blue-700 border-blue-200", gray: "bg-gray-50 text-gray-600 border-gray-200", yellow: "bg-yellow-50 text-yellow-700 border-yellow-200" };
  return <span className={`text-xs px-2 py-1 rounded-full border ${map[tone]}`}>{text}</span>
};

const Card: React.FC<{title?: string; children: React.ReactNode; className?: string; right?: React.ReactNode;}> = ({title, children, className, right}) => (
  <div className={`rounded-2xl border border-gray-200 shadow-sm bg-white p-4 ${className||""}`}>
    {(title || right) && (
      <div className="flex items-center justify-between mb-2">
        {title && <h3 className="text-sm font-semibold text-gray-700">{title}</h3>}
        {right}
      </div>
    )}
    {children}
  </div>
);

const KP: React.FC<{label:string; value:string; tone?:'green'|'red'|'gray'; hint?:string}> = ({label, value, tone='gray', hint}) => (
  <div className={`p-3 rounded-xl border ${tone==='green'? 'border-green-200 bg-green-50': tone==='red'? 'border-red-200 bg-red-50':'border-gray-200 bg-gray-50'}`}>
    <div className="text-xs text-gray-600">{label}</div>
    <div className="text-lg font-semibold">{value}</div>
    {hint && <div className="text-[10px] text-gray-500 mt-1">{hint}</div>}
  </div>
);

const Labeled: React.FC<{label:string; children:React.ReactNode}> = ({label, children}) => (
  <label className="text-xs text-gray-600 grid gap-1">{label}{children}</label>
);

// ===== Main App =====
export default function App(){
  const [tab, setTab] = useState<'overview'|'flow'|'iv'|'chains'|'trade'|'risk'|'journal'|'obs'>("overview");
  const [risk, setRisk] = useState(DEFAULT_RISK);
  const [accounts, setAccounts] = useState(DEFAULT_ACCOUNTS);
  const [providers, setProviders] = useState(DEFAULT_PROVIDERS as any);
  const [boost, setBoost] = useState<1|1.25|1.5>(1);
  const [tryIndex, setTryIndex] = useState(0); // 0..9

  // Trade state
  const [symbol, setSymbol] = useState("AAPL");
  const [optionType, setOptionType] = useState<'CALL'|'PUT'>("CALL");
  const [dte, setDte] = useState(0); // 0-2
  const [limitPrice, setLimitPrice] = useState(2.35); // premium per contract
  const [livePrice, setLivePrice] = useState(2.36);
  const [allocationMode, setAllocationMode] = useState<'equal'|'proportional'|'riskDollar'>("proportional");
  const [riskDollar, setRiskDollar] = useState(1000);
  const [pending, setPending] = useState<any[]>([]);
  const [logs, setLogs] = useState<{ts:string; msg:string; tone?:"info"|"warn"|"err"}[]>([]);

  // Derived
  const stepUnits = risk.fib_steps[tryIndex] * boost;
  const totalBudget = useMemo(()=> risk.unit * stepUnits, [risk.unit, stepUnits]);
  const priceDrift = Math.abs(livePrice - limitPrice) / (limitPrice || 1);
  const priceGuardPass = priceDrift <= risk.price_tolerance_pct;

  const addLog = (msg:string, tone?:"info"|"warn"|"err") => setLogs(x=> [{ts: now(), msg, tone}, ...x].slice(0,180));

  // Weights
  const weights = useMemo(()=>{
    const sum = accounts.reduce((a,b)=>a + (b.equity||0), 0);
    return Object.fromEntries(accounts.map(a=> [a.id, sum? (a.equity/sum):0 ]));
  }, [accounts]);

  type AllocRow = { id:string; name:string; equity:number; weight:number; allocDollar:number; contracts:number; estCost:number };
  const mkRow = (a:any, allocDollar:number): AllocRow => {
    const cost = Math.max(0, (limitPrice||0) * 100);
    const contracts = cost>0? Math.floor((allocDollar||0) / cost) : 0;
    const estCost = contracts * cost;
    return { id:a.id, name:a.name, equity:a.equity, weight:(weights as any)[a.id]||0, allocDollar, contracts, estCost };
  }
  const simulateAlloc = (): AllocRow[] => {
    let rows: AllocRow[] = [];
    if (allocationMode === 'equal'){
      const each = totalBudget / accounts.length; rows = accounts.map(a=> mkRow(a, each));
    } else if (allocationMode === 'proportional'){
      rows = accounts.map(a=> mkRow(a, totalBudget * (weights as any)[a.id] ));
    } else {
      const desired = accounts.map(a=> ({ a, alloc: Math.min(riskDollar, totalBudget)}));
      const totalDesired = desired.reduce((s,d)=> s + d.alloc, 0);
      const scale = totalDesired>0? (totalBudget/totalDesired): 0;
      rows = desired.map(d=> mkRow(d.a, d.alloc * scale));
    }
    return rows;
  };

  const onSend = () => {
    const rows = simulateAlloc();
    if (!priceGuardPass){ addLog(`Price-Guard FAILED: drift ${(priceDrift*100).toFixed(2)}% > ${(risk.price_tolerance_pct*100).toFixed(2)}%`, 'err'); return; }
    if (rows.every(r=> r.contracts===0)){ addLog('لا يوجد عقود كافية ضمن الميزانية — عدّل السعر/الميزانية', 'warn'); return; }

    const slip = (livePrice - limitPrice) / (limitPrice || 1);
    if (Math.abs(slip) > risk.slippage_max_pct){ addLog(`Slippage كبير ${(slip*100).toFixed(2)}% — الإرسال مُنع`, 'err'); return; }

    const sent = rows.map(r=> ({ account: r.name, symbol, optionType, dte, limitPrice, livePrice, requested: r.contracts, filled: 0, slipPct: slip, tsSend: Date.now() })).filter(x=> x.requested>0);
    setPending(sent);
    addLog(`أُرسلت ${sent.length} أوامر ⇢ Alloc=$${fmt.format(totalBudget)} | Slippage ${(Math.abs(slip)*100).toFixed(2)}%`, 'info');
  };
  const onFillSome = () => {
    // simulate fills & latency
    setPending(p=> p.map(x=> ({...x, filled: Math.max(x.filled, x.requested - (Math.random()<0.1? 1:0)), tsFill: (x.tsFill||Date.now()+Math.random()*800)})));
    addLog('تحديث تعبئة (محاكاة) — تحقق من Observability', 'info');
  }
  const onKill = () => { if (pending.length){ addLog(`Kill-Switch: إلغاء ${pending.length} أوامر قيد التنفيذ`, 'warn'); } setPending([]); };

  // Persist
  useEffect(()=>{ try{ localStorage.setItem('photon_accounts', JSON.stringify(accounts)); }catch{} }, [accounts]);
  useEffect(()=>{ try{ const saved = localStorage.getItem('photon_accounts'); if(saved) setAccounts(JSON.parse(saved)); }catch{} }, []);

  const rows = simulateAlloc();
  const totalRequested = rows.reduce((s,r)=> s + r.contracts, 0);
  const totalEstCost = rows.reduce((s,r)=> s + r.estCost, 0);

  return (
    <div className="min-h-dvh bg-gray-50">
      <header className="px-5 py-4 border-b bg-white sticky top-0 z-30">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="h-9 w-9 rounded-xl bg-black text-white grid place-content-center font-bold">Φ</div>
            <div>
              <h1 className="text-lg font-semibold">Photon Trader — Options (PRO)</h1>
              <p className="text-xs text-gray-500">Flows · Dealer · IV · Chains · Trade · Risk · Journal · Obs</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <Badge text={`Try #${tryIndex+1}`} tone="blue" />
            <Badge text={`Budget $${fmt.format(totalBudget)}`} tone="green" />
            <Badge text={`Boost ×${boost.toFixed(2)}`} tone="gray" />
            <button onClick={onKill} className="px-3 py-1.5 rounded-lg bg-red-600 text-white text-sm hover:bg-red-700">KILL</button>
          </div>
        </div>
        <nav className="mt-3 flex flex-wrap gap-2 text-sm">
          {([
            ['overview','Overview'],['flow','Flow'],['iv','IV'],['chains','Chains'],['trade','Trade'],['risk','Risk'],['journal','Journal'],['obs','Observability']
          ] as const).map(([key,label])=> (
            <button key={key} onClick={()=>setTab(key as any)} className={`px-3 py-1.5 rounded-xl border ${tab===key? 'bg-black text-white border-black':'bg-white hover:bg-gray-100 border-gray-200'}`}>{label}</button>
          ))}
        </nav>
      </header>

      <main className="p-5 max-w-7xl mx-auto">
        {tab==='overview' && (
          <Overview accounts={accounts} setAccounts={setAccounts} rows={rows} totalBudget={totalBudget} priceGuardPass={priceGuardPass} priceDrift={priceDrift} risk={risk} pending={pending} logs={logs} providers={providers} setProviders={setProviders} />
        )}
        {tab==='flow' && (<FlowTab />)}
        {tab==='iv' && (<IVTab />)}
        {tab==='chains' && (<ChainsTab />)}
        {tab==='trade' && (
          <TradePad
            accounts={accounts}
            rows={rows}
            symbol={symbol} setSymbol={setSymbol}
            optionType={optionType} setOptionType={setOptionType}
            dte={dte} setDte={setDte}
            limitPrice={limitPrice} setLimitPrice={setLimitPrice}
            livePrice={livePrice} setLivePrice={setLivePrice}
            allocationMode={allocationMode} setAllocationMode={setAllocationMode}
            riskDollar={riskDollar} setRiskDollar={setRiskDollar}
            tryIndex={tryIndex} setTryIndex={setTryIndex}
            boost={boost} setBoost={setBoost}
            totalBudget={totalBudget} totalRequested={totalRequested} totalEstCost={totalEstCost}
            priceDrift={priceDrift} priceGuardPass={priceGuardPass} risk={risk}
            onSend={onSend} onKill={onKill} onFillSome={onFillSome}
            pending={pending}
          />)}
        {tab==='risk' && (<RiskConsole risk={risk} setRisk={setRisk} providers={providers} setProviders={setProviders} />)}
        {tab==='journal' && (<JournalTab />)}
        {tab==='obs' && (<ObservabilityTab pending={pending} />)}
      </main>
    </div>
  );
}

// ===== Overview =====
function Overview({accounts, setAccounts, rows, totalBudget, priceGuardPass, priceDrift, risk, pending, logs, providers, setProviders}:{
  accounts:any[]; setAccounts:Function; rows:any[]; totalBudget:number; priceGuardPass:boolean; priceDrift:number; risk:any; pending:any[]; logs:{ts:string; msg:string; tone?:string}[]; providers:any; setProviders:Function;
}){
  const sumEquity = accounts.reduce((s,a)=> s + (a.equity||0), 0);
  const sumDay = accounts.reduce((s,a)=> s + (a.pnlDay||0), 0);

  return (
    <div className="grid grid-cols-12 gap-4">
      <Card className="col-span-12" title="ملخص سريع">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <KP label="إجمالي رأس المال" value={`$${fmt.format(sumEquity)}`} />
          <KP label="ربح/خسارة اليوم" value={`$${fmt.format(sumDay)}`} tone={sumDay>=0? 'green':'red'} />
          <KP label="ميزانية الخطوة الحالية" value={`$${fmt.format(totalBudget)}`} />
          <KP label="Price‑Guard" value={priceGuardPass? 'PASS':'BLOCK'} tone={priceGuardPass? 'green':'red'} hint={`drift ${(priceDrift*100).toFixed(2)}% · tol ${(risk.price_tolerance_pct*100).toFixed(2)}%`} />
        </div>
      </Card>

      <Card className="col-span-12 lg:col-span-8" title="المحافظ">
        <table className="w-full text-sm">
          <thead>
            <tr className="text-left text-gray-500">
              <th className="py-2">المحفظة</th>
              <th>Equity</th>
              <th>ربح/خسارة اليوم</th>
              <th className="text-right">وزن التخصيص</th>
            </tr>
          </thead>
          <tbody>
            {accounts.map((a,i)=> (
              <tr key={a.id} className="border-t">
                <td className="py-2 flex items-center gap-2"><span className="text-gray-700 font-medium">{a.name}</span></td>
                <td>
                  <input type="number" value={a.equity}
                    onChange={e=>{ const v = Number(e.target.value||0); const copy = [...accounts]; copy[i] = {...copy[i], equity:v}; setAccounts(copy); }}
                    className="w-28 px-2 py-1 rounded border" />
                </td>
                <td className={a.pnlDay>=0? 'text-green-600':'text-red-600'}>{fmt.format(a.pnlDay)}</td>
                <td className="text-right text-gray-500">{pct((rows.find(r=> r.id===a.id)?.weight)||0)}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </Card>

      <Card className="col-span-12 lg:col-span-4" title="التنفيذ الحالي" right={<Badge text={`${pending.length} pending`} tone={pending.length? 'blue':'gray'} />}>
        <div className="h-48 overflow-auto text-sm">
          {pending.length===0 && <div className="text-gray-500">لا يوجد أوامر قيد التنفيذ.</div>}
          {pending.map((p,i)=> (
            <div key={i} className="border-b py-2">
              <div className="flex items-center justify-between">
                <div className="font-medium">{p.account}</div>
                <Badge text={`${p.filled}/${p.requested} filled`} tone={p.filled? 'green':'red'} />
              </div>
              <div className="text-gray-600">{p.symbol} {p.optionType} · DTE {p.dte} · {p.limitPrice} → {p.livePrice}</div>
            </div>
          ))}
        </div>
      </Card>

      <Card className="col-span-12 lg:col-span-6" title="مزوّدو البيانات (Config)">
        <div className="grid grid-cols-2 gap-3 text-sm">
          {Object.entries(providers).map(([k,v]:any)=> (
            <div key={k} className="flex items-center justify-between gap-2 border rounded-xl p-2">
              <div className="grid text-xs">
                <div className="font-medium">{k}</div>
                <div className="text-gray-500">{v.enabled? 'Enabled':'Disabled'}</div>
              </div>
              <div className="flex items-center gap-2">
                <input value={v.apiKey} onChange={e=>setProviders((p:any)=> ({...p, [k]: {...p[k], apiKey: e.target.value}}))} className="px-2 py-1 rounded border" placeholder="API Key" />
                <button onClick={()=>setProviders((p:any)=> ({...p, [k]: {...p[k], enabled: !p[k].enabled}}))} className={`px-2 py-1 rounded ${v.enabled? 'bg-green-600 text-white':'bg-gray-200 text-gray-700'}`}>{v.enabled? 'On':'Off'}</button>
              </div>
            </div>
          ))}
        </div>
      </Card>

      <Card className="col-span-12 lg:col-span-6" title="السجل">
        <div className="h-40 overflow-auto text-sm">
          {logs.length===0 && <div className="text-gray-500">لا يوجد أحداث بعد.</div>}
          {logs.map((l,i)=> (
            <div key={i} className="flex items-center gap-3 py-1">
              <span className={`text-[10px] px-1.5 py-0.5 rounded ${l.tone==='err'?'bg-red-100 text-red-700': l.tone==='warn'?'bg-yellow-100 text-yellow-700':'bg-gray-100 text-gray-700'}`}>{l.ts}</span>
              <div className="text-gray-800">{l.msg}</div>
            </div>
          ))}
        </div>
      </Card>
    </div>
  );
}

// ===== Flow & Dealer =====
function FlowTab(){
  return (
    <div className="grid grid-cols-12 gap-4">
      <Card className="col-span-12 lg:col-span-7" title="Unusual Options — Blocks & Sweeps">
        <div className="overflow-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left text-gray-500">
                <th className="py-2">Time</th><th>Type</th><th>Symbol</th><th>Side</th><th>Size</th><th>Premium</th><th>Δ</th><th>Note</th>
              </tr>
            </thead>
            <tbody>
              {demoFlows.map((f,i)=>(
                <tr key={i} className="border-t">
                  <td className="py-2">{f.ts}</td><td>{f.type}</td><td>{f.symbol}</td><td>{f.side}</td>
                  <td>{fmt.format(f.size)}</td><td>${fmt.format(f.prem)}</td><td>{(f.delta>0?'+':'')+f.delta.toFixed(2)}</td><td className="text-gray-600">{f.note}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>

      <Card className="col-span-12 lg:col-span-5" title="Dealer GEX Map (Strike vs GEX)">
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={demoGEX}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="strike" /><YAxis /><Tooltip />
              <Bar dataKey="gex" />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </Card>
    </div>
  );
}

// ===== IV & Surface =====
function IVTab(){
  return (
    <div className="grid grid-cols-12 gap-4">
      <Card className="col-span-12 lg:col-span-6" title="Term Structure (IV by DTE)">
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <AreaChart data={demoTerm}>
              <defs>
                <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopOpacity={0.3}/>
                  <stop offset="95%" stopOpacity={0}/>
                </linearGradient>
              </defs>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="dte" /><YAxis tickFormatter={(v)=> (v*100).toFixed(0)+'%'} />
              <Tooltip formatter={(v:any)=> (v*100).toFixed(2)+'%'} />
              <Area type="monotone" dataKey="iv" strokeWidth={2} fillOpacity={1} fill="url(#g)" />
            </AreaChart>
          </ResponsiveContainer>
        </div>
      </Card>

      <Card className="col-span-12 lg:col-span-6" title="IV Surface (table mock)">
        <div className="overflow-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left text-gray-500">
                <th className="py-2">Strike</th>
                <th>0D</th><th>1D</th><th>2D</th><th>1W</th><th>2W</th><th>1M</th>
              </tr>
            </thead>
            <tbody>
              {demoSurface.map((r,i)=> (
                <tr key={i} className="border-t">
                  <td className="py-2">{r.strike}</td>
                  <td>{pct(r.m0)}</td><td>{pct(r.m1)}</td><td>{pct(r.m2)}</td><td>{pct(r.w1)}</td><td>{pct(r.w2)}</td><td>{pct(r.mth1)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
}

// ===== Chains & Greeks =====
function ChainsTab(){
  const [dte, setDte] = useState(0);
  const [deltaMin, setDeltaMin] = useState(0.2);
  const [deltaMax, setDeltaMax] = useState(0.45);
  const filtered = demoChain.filter(x=> x.delta>=deltaMin && x.delta<=deltaMax);

  return (
    <div className="grid grid-cols-12 gap-4">
      <Card className="col-span-12" title="Filters">
        <div className="flex flex-wrap items-end gap-3 text-sm">
          <Labeled label="DTE"><select value={dte} onChange={e=>setDte(Number(e.target.value))} className="px-2 py-1 rounded border"><option value={0}>0</option><option value={1}>1</option><option value={2}>2</option></select></Labeled>
          <Labeled label="Δ min"><input type="number" step="0.01" value={deltaMin} onChange={e=>setDeltaMin(Number(e.target.value))} className="px-2 py-1 rounded border w-24"/></Labeled>
          <Labeled label="Δ max"><input type="number" step="0.01" value={deltaMax} onChange={e=>setDeltaMax(Number(e.target.value))} className="px-2 py-1 rounded border w-24"/></Labeled>
        </div>
      </Card>

      <Card className="col-span-12" title="Option Chain (Δ/Γ/Θ/ν)">
        <div className="overflow-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left text-gray-500">
                <th className="py-2">Strike</th><th>Bid</th><th>Ask</th><th>Vol</th><th>OI</th><th>IV</th><th>Δ</th><th>Γ</th><th>Θ</th><th>ν</th>
              </tr>
            </thead>
            <tbody>
              {filtered.map((r,i)=> (
                <tr key={i} className="border-t">
                  <td className="py-2">{r.strike}</td><td>{r.bid}</td><td>{r.ask}</td><td>{r.vol}</td><td>{r.oi}</td>
                  <td>{r.iv}</td><td>{r.delta}</td><td>{r.gamma}</td><td>{r.theta}</td><td>{r.vega}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
}

// ===== Trade Pad =====
function TradePad({
  accounts, rows,
  symbol, setSymbol, optionType, setOptionType, dte, setDte,
  limitPrice, setLimitPrice, livePrice, setLivePrice,
  allocationMode, setAllocationMode, riskDollar, setRiskDollar,
  tryIndex, setTryIndex, boost, setBoost,
  totalBudget, totalRequested, totalEstCost,
  priceDrift, priceGuardPass, risk,
  onSend, onKill, onFillSome, pending
}:{
  accounts:any[]; rows:any[];
  symbol:string; setSymbol:Function;
  optionType:'CALL'|'PUT'; setOptionType:Function;
  dte:number; setDte:Function;
  limitPrice:number; setLimitPrice:Function;
  livePrice:number; setLivePrice:Function;
  allocationMode:'equal'|'proportional'|'riskDollar'; setAllocationMode:Function;
  riskDollar:number; setRiskDollar:Function;
  tryIndex:number; setTryIndex:Function;
  boost:1|1.25|1.5; setBoost:Function;
  totalBudget:number; totalRequested:number; totalEstCost:number;
  priceDrift:number; priceGuardPass:boolean; risk:any;
  onSend:()=>void; onKill:()=>void; onFillSome:()=>void; pending:any[];
}){
  return (
    <div className="grid grid-cols-12 gap-4">
      <Card className="col-span-12" title="لوحة التنفيذ (Trade Pad)">
        <div className="grid grid-cols-12 gap-3">
          <div className="col-span-12 md:col-span-8 grid grid-cols-2 md:grid-cols-4 gap-3">
            <Labeled label="Symbol"><input value={symbol} onChange={e=>setSymbol(e.target.value.toUpperCase())} className="w-full px-2 py-1 rounded border" /></Labeled>
            <Labeled label="Type"><select value={optionType} onChange={e=>setOptionType(e.target.value as any)} className="w-full px-2 py-1 rounded border"><option>CALL</option><option>PUT</option></select></Labeled>
            <Labeled label="DTE"><select value={dte} onChange={e=>setDte(Number(e.target.value))} className="w-full px-2 py-1 rounded border"><option value={0}>0</option><option value={1}>1</option><option value={2}>2</option></select></Labeled>
            <Labeled label="Limit Premium ($)"><input type="number" step="0.01" value={limitPrice} onChange={e=>setLimitPrice(Number(e.target.value||0))} className="w-full px-2 py-1 rounded border" /></Labeled>
            <Labeled label="Live Premium ($)"><input type="number" step="0.01" value={livePrice} onChange={e=>setLivePrice(Number(e.target.value||0))} className="w-full px-2 py-1 rounded border" /></Labeled>
            <Labeled label="Allocation Mode"><select value={allocationMode} onChange={e=>setAllocationMode(e.target.value as any)} className="w-full px-2 py-1 rounded border"><option value="proportional">Proportional</option><option value="equal">Equal</option><option value="riskDollar">Risk-Dollar</option></select></Labeled>
            {allocationMode==='riskDollar' && (<Labeled label="Risk $/Account"><input type="number" value={riskDollar} onChange={e=>setRiskDollar(Number(e.target.value||0))} className="w-full px-2 py-1 rounded border" /></Labeled>)}
            <Labeled label="Try #"><select value={tryIndex} onChange={e=>setTryIndex(Number(e.target.value))} className="w-full px-2 py-1 rounded border">{Array.from({length: 10}).map((_,i)=> <option key={i} value={i}>{i+1}</option>)}</select></Labeled>
            <Labeled label="Boost"><select value={boost} onChange={e=>setBoost(Number(e.target.value) as any)} className="w-full px-2 py-1 rounded border"><option value={1}>×1.00</option><option value={1.25}>×1.25</option><option value={1.5}>×1.50</option></select></Labeled>
          </div>

          <div className="col-span-12 md:col-span-4 grid grid-cols-2 gap-3">
            <KP label="Budget (Step)" value={`$${fmt.format(totalBudget)}`} />
            <KP label="Contracts (req.)" value={`${fmt.format(totalRequested)}`} />
            <KP label="Est. Cost" value={`$${fmt.format(totalEstCost)}`} />
            <KP label="Price‑Guard" value={priceGuardPass? 'PASS':'BLOCK'} tone={priceGuardPass? 'green':'red'} hint={`drift ${(priceDrift*100).toFixed(2)}% ≤ ${(risk.price_tolerance_pct*100).toFixed(2)}%`} />
          </div>
        </div>

        <div className="mt-4 overflow-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left text-gray-500">
                <th className="py-2">المحفظة</th><th>Equity</th><th>Weight</th><th>Alloc $</th><th>Contracts</th><th className="text-right">Est. Cost</th>
              </tr>
            </thead>
            <tbody>
              {rows.map((r:any)=> (
                <tr key={r.id} className="border-t">
                  <td className="py-2">{r.name}</td>
                  <td>{fmt.format(r.equity)}</td>
                  <td className="text-gray-500">{pct(r.weight||0)}</td>
                  <td>${fmt.format(r.allocDollar||0)}</td>
                  <td className="font-medium">{r.contracts}</td>
                  <td className="text-right">${fmt.format(r.estCost)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <div className="flex items-center gap-3 mt-4">
          <button onClick={onSend} className="px-4 py-2 rounded-xl bg-black text-white text-sm hover:bg-gray-900">Send Orders</button>
          <button onClick={onFillSome} className="px-3 py-2 rounded-xl bg-blue-600 text-white text-sm hover:bg-blue-700">Mock Fill</button>
          <button onClick={onKill} className="px-3 py-2 rounded-xl bg-red-600 text-white text-sm hover:bg-red-700">Kill</button>
          <div className="text-xs text-gray-500">Hints: Enter إرسال · F محاكاة تعبئة · Esc إلغاء</div>
        </div>
      </Card>

      <Card className="col-span-12" title="أوامر قيد التنفيذ">
        <div className="overflow-auto text-sm">
          {pending.length===0 && <div className="text-gray-500">لا يوجد أوامر.</div>}
          {pending.map((p,i)=> (
            <div key={i} className="border-b py-2 flex items-center justify-between">
              <div>
                <div className="font-medium">{p.account} — {p.symbol} {p.optionType} · DTE {p.dte}</div>
                <div className="text-gray-600 text-xs">{p.requested} req · {p.filled||0} filled · slip {(Math.abs(p.slipPct)*100).toFixed(2)}%</div>
              </div>
              <Badge text={p.filled? 'FILLED':'PENDING'} tone={p.filled? 'green':'yellow'} />
            </div>
          ))}
        </div>
      </Card>
    </div>
  );
}

// ===== Risk Console + Providers =====
function RiskConsole({risk, setRisk, providers, setProviders}:{risk:any; setRisk:Function; providers:any; setProviders:Function}){
  const [loc, setLoc] = useState(JSON.stringify(risk, null, 2));
  useEffect(()=>{ setLoc(JSON.stringify(risk, null, 2)); }, [risk]);
  const save = () => { try { const obj = JSON.parse(loc); setRisk(obj); } catch { alert('JSON غير صالح'); } };

  return (
    <div className="grid grid-cols-12 gap-4">
      <Card className="col-span-12 lg:col-span-7" title="Risk Engine — JSON">
        <textarea value={loc} onChange={e=>setLoc(e.target.value)} className="w-full h-96 font-mono text-xs p-3 rounded-xl border" />
        <div className="mt-3 flex items-center gap-3">
          <button onClick={save} className="px-4 py-2 rounded-xl bg-black text-white text-sm hover:bg-gray-900">Save</button>
          <span className="text-xs text-gray-500">عدّل الإعدادات والتسامح والحدود حسب يومك.</span>
        </div>
      </Card>

      <Card className="col-span-12 lg:col-span-5" title="موفّري البيانات (API Keys)">
        <div className="grid gap-2 text-sm">
          {Object.entries(providers).map(([k,v]:any)=> (
            <div key={k} className="flex items-center justify-between gap-2 border rounded-xl p-2">
              <div className="grid text-xs"><div className="font-medium">{k}</div><div className="text-gray-500">{v.enabled? 'Enabled':'Disabled'}</div></div>
              <div className="flex items-center gap-2">
                <input value={v.apiKey} onChange={e=>setProviders((p:any)=> ({...p, [k]: {...p[k], apiKey: e.target.value}}))} className="px-2 py-1 rounded border" placeholder="API Key" />
                <button onClick={()=>setProviders((p:any)=> ({...p, [k]: {...p[k], enabled: !p[k].enabled}}))} className={`px-2 py-1 rounded ${v.enabled? 'bg-green-600 text-white':'bg-gray-200 text-gray-700'}`}>{v.enabled? 'On':'Off'}</button>
              </div>
            </div>
          ))}
        </div>
        <div className="text-[11px] text-gray-500 mt-2">نقاط الربط المقترحة: REST لطلبات الدُفعات · WebSockets للتيارات اللحظية · Failover لمزوّد احتياطي.</div>
      </Card>

      <Card className="col-span-12" title="قواعد التشغيل (ملخص)">
        <ul className="text-sm list-disc pl-5 space-y-1 text-gray-700">
          <li>Daily Loss ≤ {(risk.loss_limits.daily_pct*100).toFixed(1)}% · Weekly ≤ {(risk.loss_limits.weekly_pct*100).toFixed(1)}%</li>
          <li>Target R = {risk.target_R} · Profit Withdraw = {(risk.profit_withdraw_pct*100).toFixed(0)}%</li>
          <li>Cap Steps: ×1.00 ≤ {risk.daily_cap_step_max.x1_0}, ×1.25 ≤ {risk.daily_cap_step_max.x1_25}, ×1.50 ≤ {risk.daily_cap_step_max.x1_5}</li>
          <li>Price‑Guard ≤ {(risk.price_tolerance_pct*100).toFixed(2)}% · Slippage ≤ {(risk.slippage_max_pct*100).toFixed(2)}%</li>
          <li>Cool‑Down بعد خسارتين: {risk.cool_down_on_2_losses_min} دقيقة</li>
        </ul>
      </Card>
    </div>
  );
}

// ===== Journal =====
function JournalTab(){
  const [items, setItems] = useState<{ts:string; why:string; what:string; result:string; lesson:string}[]>([]);
  const [why, setWhy] = useState("");
  const [what, setWhat] = useState("");
  const [result, setResult] = useState("");
  const [lesson, setLesson] = useState("");

  const add = () => {
    if(!why || !what) return;
    setItems(i=> [{ts: now(), why, what, result, lesson}, ...i]);
    setWhy(""); setWhat(""); setResult(""); setLesson("");
  };

  return (
    <div className="grid grid-cols-12 gap-4">
      <Card className="col-span-12" title="Journal AI (يدوي الآن — يربط Notion لاحقًا)">
        <div className="grid md:grid-cols-4 gap-3 text-sm">
          <Labeled label="Why (السبب)"><input value={why} onChange={e=>setWhy(e.target.value)} className="w-full px-2 py-1 rounded border"/></Labeled>
          <Labeled label="What (الإجراء)"><input value={what} onChange={e=>setWhat(e.target.value)} className="w-full px-2 py-1 rounded border"/></Labeled>
          <Labeled label="Result (W/L)"><input value={result} onChange={e=>setResult(e.target.value)} className="w-full px-2 py-1 rounded border"/></Labeled>
          <Labeled label="Lesson (الدرس)"><input value={lesson} onChange={e=>setLesson(e.target.value)} className="w-full px-2 py-1 rounded border"/></Labeled>
        </div>
        <div className="mt-3"><button onClick={add} className="px-4 py-2 rounded-xl bg-black text-white text-sm hover:bg-gray-900">Add Note</button></div>
      </Card>

      <Card className="col-span-12" title="السجل">
        <div className="overflow-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left text-gray-500"><th className="py-2">Time</th><th>Why</th><th>What</th><th>Result</th><th>Lesson</th></tr>
            </thead>
            <tbody>
              {items.map((r,i)=> (
                <tr key={i} className="border-t"><td className="py-2">{r.ts}</td><td>{r.why}</td><td>{r.what}</td><td>{r.result}</td><td className="text-gray-600">{r.lesson}</td></tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
}

// ===== Observability =====
function ObservabilityTab({pending}:{pending:any[]}){
  // KPIs من المحاكاة
  const count = pending.length;
  const filled = pending.filter(p=> p.filled>0).length;
  const fillRatio = count? filled/count: 0;
  const avgSlip = count? (pending.reduce((s,p)=> s + Math.abs(p.slipPct||0), 0)/count): 0;
  const avgLatencyMs = count? (pending.reduce((s,p)=> s + Math.max(0,(p.tsFill||Date.now()) - (p.tsSend||Date.now())),0)/count): 0;

  return (
    <div className="grid grid-cols-12 gap-4">
      <Card className="col-span-12" title="KPIs">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          <KP label="Orders" value={`${count}`} />
          <KP label="Fill‑ratio" value={pct(fillRatio)} tone={fillRatio>=0.95? 'green':'red'} />
          <KP label="Avg Slippage" value={pct(avgSlip)} tone={avgSlip<=0.003? 'green':'red'} />
          <KP label="Avg Time‑to‑Fill" value={`${avgLatencyMs.toFixed(0)} ms`} />
        </div>
      </Card>

      <Card className="col-span-12" title="Slippage Distribution (abs)">
        <div className="h-64">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={pending.map((p,i)=> ({i, s: Math.abs(p.slipPct||0)}))}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="i" /><YAxis tickFormatter={(v)=> (v*100).toFixed(1)+'%'} />
              <Tooltip formatter={(v:any)=> (v*100).toFixed(2)+'%'} />
              <Bar dataKey="s" />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </Card>
    </div>
  );
}
